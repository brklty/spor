<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spor Takip</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#f2f2f7; }
header { background:#111; color:white; padding:16px; font-size:20px; text-align:center; position:relative; }
.home-btn {
  position:absolute;
  right:12px;
  top:12px;
  background:#333;
  color:white;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  font-size:18px;
}
.container { padding:16px; }
.card { background:white; border-radius:12px; padding:16px; margin-bottom:12px; }
button { font-size:17px; padding:14px; width:100%; border:none; border-radius:10px; background:black; color:white; margin-bottom:10px; }
.list-item { padding:12px; border-bottom:1px solid #ddd; display:flex; align-items:center; gap:10px; }
.list-item:last-child { border-bottom:none; }
.list-main { flex:1; }
.icon-btn { background:#eee; border:none; border-radius:8px; padding:8px 10px; font-size:16px; }
.icon-btn.delete { background:#ffdddd; }
.icon-btn.export { background:#ddeaff; }
.done { color:green; font-weight:600; }
.todo { color:#999; }
.set-row { display:flex; gap:8px; }
.set-row input { flex:1; padding:10px; font-size:16px; }
input, select { padding:10px; font-size:16px; width:100%; margin-bottom:8px; }
.small { color:#666; font-size:14px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
canvas { width:100%; height:260px; border:1px solid #eee; border-radius:8px; }
.workout-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #f2f2f7;
  padding: 10px 16px calc(env(safe-area-inset-bottom) + 10px);
  border-top: 1px solid #ddd;
  display: flex;
  gap: 10px;
  z-index: 1000;
}

.workout-footer button {
  flex: 1;
  margin-bottom: 0;
}

</style>
</head>
<body>

<header>
  ğŸ‹ï¸ Spor Takip
  <button id="homeBtn" class="home-btn" onclick="goHome()" style="display:none">ğŸ </button>
</header>

<div class="container" id="app"></div>

<input type="file" id="fileInput" accept=".csv" style="display:none" />
<input type="file" id="backupInput" accept=".json" style="display:none" />


<script>
const BOM = "\uFEFF";

let state = {
  screen: "home",
  selectedProgram: null,
};

// ===== Storage =====
function getPrograms() { return JSON.parse(localStorage.getItem("programs") || "[]"); }
function savePrograms(p) { localStorage.setItem("programs", JSON.stringify(p)); }
function getMeasures() { return JSON.parse(localStorage.getItem("measures") || "[]"); }
function saveMeasures(m) { localStorage.setItem("measures", JSON.stringify(m)); }

// ===== Navigation =====
function goHome(){ state.screen="home"; render(); }
function goPrograms(){ state.screen="programs"; render(); }
function goMeasures(){ state.screen="measures"; render(); }
function goMeasureExport(){ state.screen="measureExport"; render(); }
function goMeasureCharts(){ state.screen="measureCharts"; render(); }
function goExerciseCharts(){ state.screen="exerciseCharts"; render(); }


// ===== Render =====
function render(){
  const app = document.getElementById("app");
  const homeBtn = document.getElementById("homeBtn");

  homeBtn.style.display = (state.screen === "home") ? "none" : "block";

  app.innerHTML = "";

  if(state.screen==="home"){
    app.innerHTML = `
      <div class="card"><button onclick="goPrograms()">ğŸ“‹ Program SeÃ§</button></div>
      <div class="card"><button onclick="goMeasures()">âš–ï¸ Ã–lÃ§Ã¼ Takibi</button></div>
      <div class="card"><button onclick="goExerciseCharts()">ğŸ“ˆ GeliÅŸim Grafikleri</button></div>
      <div class="card"><button onclick="importProgram()">â• Yeni Program Ekle (CSV)</button></div>
      <div class="card"><button onclick="startImportBackup()">ğŸ“¥ Yedek Ä°Ã§e Aktar</button></div>

    `;
  }

  if(state.screen==="programs"){
    const programs = getPrograms();
    let html = `<div class="card"><h3>ğŸ“‹ Programlar</h3>`;
    programs.forEach((p,i)=>{
      html += `
        <div class="list-item" onclick="openProgram(${i})">
          <div class="list-main">${p.name}</div>
          <button class="icon-btn export" onclick="event.stopPropagation(); exportProgramMenu(${i})">ğŸ“¤</button>
          <button class="icon-btn" onclick="event.stopPropagation(); renameProgram(${i})">âœï¸</button>
          <button class="icon-btn delete" onclick="event.stopPropagation(); deleteProgram(${i})">ğŸ—‘ï¸</button>
        </div>
  `;

});

    html += `</div><button onclick="goHome()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html;
  }

  if(state.screen==="programDetail"){
    const p = state.selectedProgram;
    let html = `<div class="card"><h3>${p.name}</h3>`;
    p.days.forEach((d,i)=>{
      html += `
        <div class="list-item" onclick="openDay(${i})">
          <div class="list-main">
            ${d.name} - ${d.records ? "<span class='done'>TamamlandÄ±</span>" : "<span class='todo'>YapÄ±lmadÄ±</span>"}
          </div>
        </div>
      `;
    });
    html += `</div><button onclick="goPrograms()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html;
  }

  if(state.screen==="workout"){
    const programs = getPrograms();
    const day = programs[state.programIndex].days[state.selectedDayIndex];

    const today = new Date().toISOString().slice(0,10);
    const selectedDate = day.date || today;

    let html = `<div class="card">
      <h3>${day.name}</h3>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
      <div class="small" style="white-space:nowrap;">ğŸ“… Antreman Tarihi</div>
      <input
        type="date"
        id="workout-date"
        value="${selectedDate}"
        style="flex:1;padding:6px 8px;font-size:15px;"
      >
    </div>
    `;


    day.exercises.forEach((ex,ei)=>{
      const comment = day.comments?.[ex.name] || "";
      html += `<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <b>${ex.name}</b>
          <button class="icon-btn" onclick="toggleHistory('${ex.name.replace(/'/g,"\\'")}', ${ei})">ğŸ“œ</button>
        </div>

        <div class="small">Hedef: ${ex.sets} x ${ex.reps}</div>
        <textarea id="comment-${ei}" placeholder="ğŸ“ Not / Yorum (opsiyonel)" style="width:100%;margin-top:8px;">${comment}</textarea>
        <div id="history-${ei}" style="display:none;margin-top:8px;"></div>
      `;

      for(let s=0;s<ex.sets;s++){
        const old = day.records?.[ex.name]?.[s] || {};
        html += `
          <div class="set-row">
            <input placeholder="Set ${s+1} KG" id="kg-${ei}-${s}" value="${old.kg||""}">
            <input placeholder="Tekrar" id="rep-${ei}-${s}" value="${old.rep||""}">
          </div>
        `;
      }
      html += `</div>`;
    });
// --- Manuel hareket ekleme formu ---
    html += `
      <div class="card">
        <h4>â• Hareket Ekle</h4>
        <input id="new-ex-name" placeholder="Hareket adÄ±">
        <input id="new-ex-sets" type="number" min="1" placeholder="Set sayÄ±sÄ±">
        <button onclick="addExerciseToDay()">â• Ekle</button>
      </div>
    `;

    html += `
      <div style="height:90px;"></div>
      <div class="workout-footer">
        <button onclick="renderProgramDetail()">â¬…ï¸ Geri</button>
        <button onclick="saveDay()">ğŸ’¾ GÃ¼nÃ¼ Kaydet</button>
      </div>
`    ;

    app.innerHTML = html;
  }

  if(state.screen==="measures"){
    const today = new Date().toISOString().slice(0,10);
    let measures = getMeasures().slice().sort((a,b)=> a.date.localeCompare(b.date));

    let list = measures.map(m=>`
      <div class="list-item">
        <div class="list-main">
          <b>${m.date}</b>
          <div class="small">
            Kilo:${m.weight||""} | Bel:${m.waist||""} | GÃ¶ÄŸÃ¼s:${m.chest||""} | Kol:${m.arm||""} | Omuz:${m.shoulder||""} | KalÃ§a:${m.hip||""}
          </div>
        </div>
        <button class="icon-btn" onclick="editMeasure('${m.date}')">âœï¸</button>
        <button class="icon-btn delete" onclick="deleteMeasure('${m.date}')">ğŸ—‘ï¸</button>
      </div>
    `).join("");

    app.innerHTML = `
      <div class="card">
        <h3>âš–ï¸ Ã–lÃ§Ã¼ GiriÅŸi</h3>
        <input type="date" id="m-date" value="${today}">
        <div class="grid">
          <input id="m-weight" placeholder="Kilo">
          <input id="m-waist" placeholder="Bel">
          <input id="m-chest" placeholder="GÃ¶ÄŸÃ¼s">
          <input id="m-arm" placeholder="Kol">
          <input id="m-shoulder" placeholder="Omuz">
          <input id="m-hip" placeholder="KalÃ§a">
        </div>
        <button onclick="saveMeasure()">ğŸ’¾ Kaydet / GÃ¼ncelle</button>
        <button onclick="goMeasureExport()">ğŸ“¤ Ã–lÃ§Ã¼leri Export</button>
        <button onclick="goMeasureCharts()">ğŸ“ˆ Grafikleri GÃ¶r</button>
      </div>

      <div class="card">
        <h3>ğŸ“œ GeÃ§miÅŸ Ã–lÃ§Ã¼ler</h3>
        ${list || "<div class='small'>HenÃ¼z kayÄ±t yok</div>"}
      </div>

      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="measureCharts"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“ˆ Kilo GrafiÄŸi</h3>
        <canvas id="weightChart" width="400" height="260"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ“ˆ Ã–lÃ§Ã¼ GrafiÄŸi</h3>
        <select id="measureSelect" onchange="drawMeasureCharts()">
          <option value="waist">Bel</option>
          <option value="chest">GÃ¶ÄŸÃ¼s</option>
          <option value="arm">Kol</option>
          <option value="shoulder">Omuz</option>
          <option value="hip">KalÃ§a</option>
        </select>
        <canvas id="measureChart" width="400" height="260"></canvas>
      </div>

      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
    drawMeasureCharts();
  }

  if(state.screen==="measureExport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ Ã–lÃ§Ã¼ Export</h3>
        <button onclick="exportMeasuresJSON()">ğŸ“¦ JSON (Yedek)</button>
        <button onclick="exportMeasuresCSV()">ğŸ“Š CSV (Excel/GPT)</button>
      </div>
      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="programExport"){
    const i = state.exportProgramIndex;
    const programs = getPrograms();
    const p = programs[i];
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ ${p.name}</h3>
        <button onclick="exportProgramJSON(${i})">ğŸ“¦ Program JSON (Yedek)</button>
        <button onclick="exportProgramCSV(${i})">ğŸ“Š Program CSV (Antrenman KayÄ±tlarÄ±)</button>
      </div>
      <button onclick="goPrograms()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="exerciseCharts"){
    const exercises = collectAllExercises();

    if(exercises.length === 0){
      app.innerHTML = `
        <div class="card">
          <h3>ğŸ“ˆ GeliÅŸim Grafikleri</h3>
          <div class="small">HenÃ¼z hiÃ§ kayÄ±tlÄ± egzersiz yok.</div>
        </div>
        <button onclick="goHome()">â¬…ï¸ Geri</button>
      `;
      return;
    }

    let options = exercises.map(e=>`<option value="${e}">${e}</option>`).join("");

    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“ˆ GeliÅŸim Grafikleri</h3>
        <select id="exerciseSelect" onchange="drawExerciseChart()">
          ${options}
        </select>
        <canvas id="exerciseChart" width="400" height="260"></canvas>
      </div>
      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;

    drawExerciseChart();
  }

}

// ===== Charts =====
function drawMeasureCharts(){
  let measures = getMeasures().slice().sort((a,b)=> a.date.localeCompare(b.date));

  const weightData = measures.filter(m=>m.weight).map(m=>({x:m.date, v:parseFloat(m.weight)}));
  drawLineChart("weightChart", weightData, "#007aff");

  const key = document.getElementById("measureSelect").value;
  const colorMap = { waist:"#ff9500", chest:"#34c759", arm:"#af52de", shoulder:"#ff3b30", hip:"#5ac8fa" };
  const mData = measures.filter(m=>m[key]).map(m=>({x:m.date, v:parseFloat(m[key])}));
  drawLineChart("measureChart", mData, colorMap[key] || "#000");
}

function drawLineChart(canvasId, data, color){
  const c = document.getElementById(canvasId);
  if(!c) return;
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  if(data.length < 1){
    ctx.fillStyle="#999";
    ctx.fillText("Yeterli veri yok", 20, 40);
    return;
  }

  const pad = 40;
  const w = c.width - pad*2;
  const h = c.height - pad*2;

  const minY = Math.min(...data.map(d=>d.v));
  const maxY = Math.max(...data.map(d=>d.v));
  const range = (maxY - minY) || 1;

  // axes
  ctx.strokeStyle="#ccc";
  ctx.beginPath();
  ctx.moveTo(pad,pad);
  ctx.lineTo(pad,pad+h);
  ctx.lineTo(pad+w,pad+h);
  ctx.stroke();

  // labels
  ctx.fillStyle="#666";
  ctx.font="12px sans-serif";
  ctx.fillText(maxY.toFixed(1), 5, pad+5);
  ctx.fillText(minY.toFixed(1), 5, pad+h);

  // line
  ctx.strokeStyle=color;
  ctx.lineWidth=2;
  ctx.beginPath();

  data.forEach((d,i)=>{
    const x = pad + (i/(data.length-1||1))*w;
    const y = pad + h - ((d.v - minY)/range)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);

    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  ctx.stroke();
}

// ===== Program Flow, Import, Export, Measure CRUD =====
// (Bunlar stabil sÃ¼rÃ¼mle birebir aynÄ±dÄ±r)

function openProgram(i){
  const programs = getPrograms();
  state.selectedProgram = programs[i];
  state.programIndex = i;
  state.screen = "programDetail";
  render();
}
function renderProgramDetail(){ state.screen="programDetail"; render(); }
function openDay(i){ state.selectedDayIndex=i; state.screen="workout"; render(); }

function saveDay(){
  const programs = getPrograms();
  const day = programs[state.programIndex].days[state.selectedDayIndex];
  let records = {};
  let comments = {};
  day.exercises.forEach((ex,ei)=>{
    records[ex.name]=[];
    for(let s=0;s<ex.sets;s++){
      const kg = document.getElementById(`kg-${ei}-${s}`).value;
      const rep = document.getElementById(`rep-${ei}-${s}`).value;
      records[ex.name].push({kg,rep});
      const c = document.getElementById(`comment-${ei}`).value;
    if(c && c.trim()){
      comments[ex.name] = c.trim();
    }
    }
  });
  day.records = records;
  const d = document.getElementById("workout-date").value;
  if(d){
    day.date = d;
  }

  day.comments = comments;
  savePrograms(programs);
  alert("GÃ¼n kaydedildi ğŸ’ª");
  renderProgramDetail();
}
function addExerciseToDay(){
  const name = document.getElementById("new-ex-name").value.trim();
  const sets = parseInt(document.getElementById("new-ex-sets").value);

  if(!name){
    alert("Hareket adÄ± gir.");
    return;
  }
  if(!sets || sets < 1){
    alert("GeÃ§erli set sayÄ±sÄ± gir.");
    return;
  }

  const programs = getPrograms();
  const day = programs[state.programIndex].days[state.selectedDayIndex];

  // AynÄ± isimde hareket var mÄ±?
  if(day.exercises.find(x => x.name.toLowerCase() === name.toLowerCase())){
    if(!confirm("Bu isimde bir hareket zaten var. Yine de eklemek istiyor musun?")){
      return;
    }
  }

  // Yeni hareketi ekle
  day.exercises.push({
    name: name,
    sets: sets,
    reps: ""   // hedef tekrar boÅŸ, Ã§Ã¼nkÃ¼ manuel
  });

  savePrograms(programs);
  alert("Hareket eklendi âœ…");

  // EkranÄ± yenile
  render();
}

function importProgram(){ document.getElementById("fileInput").click(); }
document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = evt => parseCSV(evt.target.result);
  reader.readAsText(file);
});

function parseCSV(text){
  const lines = text.split("\n").map(l=>l.trim()).filter(l=>l);
  const rows = lines.slice(1).map(l=>l.split(","));
  const programName = rows[0][0];
  let program = { name: programName, days: [] };
  let dayMap = {};
  rows.forEach(r=>{
    const week=r[1], day=r[2], exercise=r[3];
    const sets=parseInt(r[4]), reps=parseInt(r[5]);
    const key = `Hafta ${week} GÃ¼n ${day}`;
    if(!dayMap[key]){ dayMap[key]={ name:key, exercises:[] }; program.days.push(dayMap[key]); }
    dayMap[key].exercises.push({ name:exercise, sets, reps });
  });
  const programs = getPrograms();
  programs.push(program);
  savePrograms(programs);
  alert("Program eklendi âœ…");
}

function deleteProgram(i){
  if(!confirm("Bu programÄ± silmek istiyor musun?")) return;
  const programs = getPrograms();
  programs.splice(i,1); savePrograms(programs); render();
}
function renameProgram(i){
  const programs = getPrograms();
  const newName = prompt("Yeni program adÄ±nÄ± gir:", programs[i].name);
  if(!newName) return;
  programs[i].name = newName; savePrograms(programs); render();
}

function downloadFile(filename, content, type){
  const blob = new Blob([content], {type});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportProgramMenu(i){ state.exportProgramIndex=i; state.screen="programExport"; render(); }

function exportProgramJSON(i){
  const programs = getPrograms();
  const data = JSON.stringify(programs[i], null, 2);
  downloadFile(`program_${programs[i].name}.json`, data, "application/json");
}

function exportProgramCSV(i){
  const programs = getPrograms();
  const p = programs[i];
  let rows = [];
  rows.push(["Program","GÃ¼n","Hareket","SetNo","KG","Tekrar"].join(","));
  p.days.forEach(d=>{
    if(d.records){
      Object.keys(d.records).forEach(exName=>{
        d.records[exName].forEach((set,idx)=>{
          rows.push([
            `"${p.name}"`, `"${d.name}"`, `"${exName}"`, idx+1, set.kg||"", set.rep||""
          ].join(","));
        });
      });
    }
  });
  const csv = BOM + rows.join("\n");
  downloadFile(`program_${p.name}_antrenman.csv`, csv, "text/csv;charset=utf-8;");
}

function saveMeasure(){
  const m = {
    date: document.getElementById("m-date").value,
    weight: document.getElementById("m-weight").value,
    waist: document.getElementById("m-waist").value,
    chest: document.getElementById("m-chest").value,
    arm: document.getElementById("m-arm").value,
    shoulder: document.getElementById("m-shoulder").value,
    hip: document.getElementById("m-hip").value,
  };
  let measures = getMeasures();
  measures = measures.filter(x=>x.date!==m.date);
  measures.push(m);
  saveMeasures(measures);
  alert("Ã–lÃ§Ã¼ kaydedildi âœ…");
  render();
}

function editMeasure(date){
  const m = getMeasures().find(x=>x.date===date);
  if(!m) return;
  document.getElementById("m-date").value = m.date;
  document.getElementById("m-weight").value = m.weight||"";
  document.getElementById("m-waist").value = m.waist||"";
  document.getElementById("m-chest").value = m.chest||"";
  document.getElementById("m-arm").value = m.arm||"";
  document.getElementById("m-shoulder").value = m.shoulder||"";
  document.getElementById("m-hip").value = m.hip||"";
}

function deleteMeasure(date){
  if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
  let measures = getMeasures().filter(x=>x.date!==date);
  saveMeasures(measures);
  render();
}

function exportMeasuresJSON(){
  const data = JSON.stringify(getMeasures(), null, 2);
  downloadFile("olcu_verilerim.json", data, "application/json");
}

function exportMeasuresCSV(){
  const m = getMeasures().sort((a,b)=> a.date.localeCompare(b.date));
  let rows = [];
  rows.push(["Tarih","Kilo","Bel","GÃ¶ÄŸÃ¼s","Kol","Omuz","KalÃ§a"].join(","));
  m.forEach(x=>{
    rows.push([x.date, x.weight||"", x.waist||"", x.chest||"", x.arm||"", x.shoulder||"", x.hip||""].join(","));
  });
  const csv = BOM + rows.join("\n");
  downloadFile("olcu_verilerim.csv", csv, "text/csv;charset=utf-8;");
}
// ===== BACKUP IMPORT =====

function startImportBackup(){
  document.getElementById("backupInput").value = "";
  document.getElementById("backupInput").click();
}

document.getElementById("backupInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const data = JSON.parse(evt.target.result);
      handleBackupImport(data);
    } catch(err){
      alert("Bu dosya geÃ§erli bir JSON yedeÄŸi deÄŸil.");
    }
  };
  reader.readAsText(file);
});

function handleBackupImport(data){
  // Program yedeÄŸi mi?
  if(data && data.name && data.days){
    importProgramBackup(data);
    return;
  }

  // Ã–lÃ§Ã¼ yedeÄŸi mi?
  if(Array.isArray(data) && data.length && data[0].date){
    importMeasureBackup(data);
    return;
  }

  alert("Bu dosya tanÄ±nan bir yedek formatÄ± deÄŸil.");
}

// ---- PROGRAM IMPORT ----
function importProgramBackup(p){
  let programs = getPrograms();

  const existingIndex = programs.findIndex(x => x.name === p.name);

  if(existingIndex !== -1){
    const overwrite = confirm(
      `"${p.name}" adlÄ± bir program zaten var.\n\nOK = Ãœzerine yaz\nÄ°ptal = Kopya olarak ekle`
    );

    if(overwrite){
      programs[existingIndex] = p;
    } else {
      let base = p.name;
      let i = 2;
      let newName = base + "_" + i;
      while(programs.find(x => x.name === newName)){
        i++;
        newName = base + "_" + i;
      }
      const copy = JSON.parse(JSON.stringify(p));
      copy.name = newName;
      programs.push(copy);
    }
  } else {
    programs.push(p);
  }

  savePrograms(programs);
  alert("Program iÃ§e aktarÄ±ldÄ± âœ…");
}

// ---- MEASURE IMPORT ----
function importMeasureBackup(arr){
  let measures = getMeasures();

  arr.forEach(m=>{
    measures = measures.filter(x => x.date !== m.date);
    measures.push(m);
  });

  saveMeasures(measures);
  alert("Ã–lÃ§Ã¼ yedeÄŸi iÃ§e aktarÄ±ldÄ± âœ…");
}

function collectAllExercises(){
  const programs = getPrograms();
  const set = new Set();

  programs.forEach(p=>{
    p.days.forEach(d=>{
      if(d.records){
        Object.keys(d.records).forEach(exName=>{
          set.add(exName);
        });
      }
    });
  });

  return Array.from(set).sort();
}

function drawExerciseChart(){
  const name = document.getElementById("exerciseSelect").value;
  const programs = getPrograms();

  let points = [];

  programs.forEach(p=>{
    p.days.forEach(d=>{
      if(d.records && d.records[name]){
        // o gÃ¼nkÃ¼ en iyi set
        let best = 0;
        d.records[name].forEach(s=>{
          const kg = parseFloat(s.kg);
          if(!isNaN(kg)){
            if(kg > best) best = kg;
          }
        });
        if(best > 0){
          points.push({
            x: d.name,
            v: best
          });
        }
      }
    });
  });

  drawLineChart("exerciseChart", points, "#ff2d55");
}
let openHistoryIndex = null;

function toggleHistory(exName, ei){
  const el = document.getElementById("history-" + ei);

  if(el.style.display === "block"){
    el.style.display = "none";
    el.innerHTML = "";
    openHistoryIndex = null;
    return;
  }

  // baÅŸka aÃ§Ä±k varsa kapat
  if(openHistoryIndex !== null){
    const old = document.getElementById("history-" + openHistoryIndex);
    if(old){
      old.style.display = "none";
      old.innerHTML = "";
    }
  }

  const history = collectExerciseHistory(exName);

  if(history.length === 0){
    el.innerHTML = `<div class="small">Bu hareket iÃ§in geÃ§miÅŸ kayÄ±t yok.</div>`;
  } else {
    let html = `<div class="small"><b>ğŸ“œ Son KayÄ±tlar</b></div>`;

    history.slice(0,3).forEach(h=>{
      html += `<div class="card" style="margin-top:8px;">
        <div class="small"><b>${h.date || "Tarih yok (eski kayÄ±t)"}</b></div>
      `;

      h.sets.forEach((s,idx)=>{
        html += `<div class="small">#${idx+1} ${s.kg || "-"} kg x ${s.rep || "-"}</div>`;
      });

      if(h.comment){
        html += `<div class="small">ğŸ“ ${h.comment}</div>`;
      }

      html += `</div>`;
    });

    el.innerHTML = html;
  }

  el.style.display = "block";
  openHistoryIndex = ei;
}

// tÃ¼m programlardan o hareketin geÃ§miÅŸini toplar
function collectExerciseHistory(name){
  const programs = getPrograms();
  let list = [];

  programs.forEach(p=>{
    p.days.forEach(d=>{
      if(d.records && d.records[name]){
        list.push({
          date: d.date,
          sets: d.records[name],
          comment: d.comments ? d.comments[name] : ""
        });
      }
    });
  });

  // tarihe gÃ¶re sÄ±rala (yeni â†’ eski)
  list.sort((a,b)=>{
    if(!a.date) return 1;
    if(!b.date) return -1;
    return b.date.localeCompare(a.date);
  });

  return list;
}


// ===== Init =====
render();
</script>

</body>
</html>
