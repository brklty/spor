<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spor Takip</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#f2f2f7; }
header { background:#111; color:white; padding:12px 16px; font-size:20px; text-align:center; position:relative; }
header .home-btn { position:absolute; right:12px; top:8px; font-size:22px; background:none; border:none; color:white; }
.container { padding:16px; }
.card { background:white; border-radius:12px; padding:16px; margin-bottom:12px; }
button { font-size:17px; padding:14px; width:100%; border:none; border-radius:10px; background:black; color:white; margin-bottom:10px; }
.list-item { padding:12px; border-bottom:1px solid #ddd; display:flex; align-items:center; gap:10px; }
.list-item:last-child { border-bottom:none; }
.list-main { flex:1; }
.icon-btn { background:#eee; border:none; border-radius:8px; padding:8px 10px; font-size:16px; }
.icon-btn.delete { background:#ffdddd; }
.icon-btn.export { background:#ddeaff; }
.done { color:green; font-weight:600; }
.todo { color:#999; }
.set-row { display:flex; gap:8px; }
.set-row input { flex:1; padding:10px; font-size:16px; }
input, select { padding:10px; font-size:16px; width:100%; margin-bottom:8px; }
.small { color:#666; font-size:14px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
canvas { width:100%; height:260px; border:1px solid #eee; border-radius:8px; }
</style>
</head>
<body>

<header id="header">
  ğŸ‹ï¸ Spor Takip
  <button id="homeBtn" class="home-btn" onclick="goHome()">ğŸ </button>
</header>

<div class="container" id="app"></div>

<input type="file" id="fileInput" accept=".csv" style="display:none" />
<input type="file" id="backupInput" accept=".json" style="display:none" />

<script>
var BOM = "\uFEFF";

var state = {
  screen: "home",
  selectedProgram: null
};

// ===== Storage =====
function getPrograms() { return JSON.parse(localStorage.getItem("programs") || "[]"); }
function savePrograms(p) { localStorage.setItem("programs", JSON.stringify(p)); }
function getMeasures() { return JSON.parse(localStorage.getItem("measures") || "[]"); }
function saveMeasures(m) { localStorage.setItem("measures", JSON.stringify(m)); }

// ===== Navigation =====
function goHome(){ state.screen="home"; render(); }
function goPrograms(){ state.screen="programs"; render(); }
function goMeasures(){ state.screen="measures"; render(); }
function goMeasureExport(){ state.screen="measureExport"; render(); }
function goMeasureCharts(){ state.screen="measureCharts"; render(); }
function goBackupImport(){ state.screen="backupImport"; render(); }

// ===== Render =====
function render(){
  var app = document.getElementById("app");
  var homeBtn = document.getElementById("homeBtn");

  // Ana sayfadaysak ğŸ  gizle
  if(state.screen === "home"){
    homeBtn.style.display = "none";
  } else {
    homeBtn.style.display = "block";
  }

  app.innerHTML = "";

  if(state.screen==="home"){
    app.innerHTML = `
      <div class="card"><button onclick="goPrograms()">ğŸ“‹ Program SeÃ§</button></div>
      <div class="card"><button onclick="goMeasures()">âš–ï¸ Ã–lÃ§Ã¼ Takibi</button></div>
      <div class="card"><button onclick="importProgram()">â• Yeni Program Ekle (CSV)</button></div>
      <div class="card"><button onclick="goBackupImport()">ğŸ“¥ Yedek Ä°Ã§e Aktar</button></div>
    `;
  }

  if(state.screen==="backupImport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¥ Yedek Ä°Ã§e Aktar</h3>
        <div class="small">Program JSON veya Ã–lÃ§Ã¼ JSON dosyasÄ±nÄ± seÃ§ebilirsin.</div>
        <button onclick="selectBackup()">ğŸ“‚ Dosya SeÃ§</button>
        <div class="small">âš ï¸ Mevcut verilerin Ã¼stÃ¼ne yazabilir veya ekleyebilir.</div>
      </div>
      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="programs"){
    var programs = getPrograms();
    var html = `<div class="card"><h3>ğŸ“‹ Programlar</h3>`;
    programs.forEach(function(p,i){
      html += `
        <div class="list-item">
          <div class="list-main" onclick="openProgram(${i})">${p.name}</div>
          <button class="icon-btn export" onclick="exportProgramMenu(${i})">ğŸ“¤</button>
          <button class="icon-btn" onclick="renameProgram(${i})">âœï¸</button>
          <button class="icon-btn delete" onclick="deleteProgram(${i})">ğŸ—‘ï¸</button>
        </div>
      `;
    });
    html += `</div><button onclick="goHome()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html;
  }

  if(state.screen==="programDetail"){
    var p = state.selectedProgram;
    var html2 = `<div class="card"><h3>${p.name}</h3>`;
    p.days.forEach(function(d,i){
      html2 += `
        <div class="list-item" onclick="openDay(${i})">
          <div class="list-main">
            ${d.name} - ${d.records ? "<span class='done'>TamamlandÄ±</span>" : "<span class='todo'>YapÄ±lmadÄ±</span>"}
          </div>
        </div>
      `;
    });
    html2 += `</div><button onclick="goPrograms()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html2;
  }

  if(state.screen==="workout"){
    var programs2 = getPrograms();
    var day = programs2[state.programIndex].days[state.selectedDayIndex];
    var html3 = `<div class="card"><h3>${day.name}</h3>`;

    day.exercises.forEach(function(ex,ei){
      html3 += `<div class="card">
        <b>${ex.name}</b>
        <div class="small">Hedef: ${ex.sets} x ${ex.reps}</div>`;
      for(var s=0;s<ex.sets;s++){
        var old = (day.records && day.records[ex.name] && day.records[ex.name][s]) || {};
        html3 += `
          <div class="set-row">
            <input placeholder="Set ${s+1} KG" id="kg-${ei}-${s}" value="${old.kg||""}">
            <input placeholder="Tekrar" id="rep-${ei}-${s}" value="${old.rep||""}">
          </div>
        `;
      }
      html3 += `</div>`;
    });

    html3 += `<button onclick="saveDay()">ğŸ’¾ GÃ¼nÃ¼ Kaydet</button>
             <button onclick="renderProgramDetail()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html3;
  }

  if(state.screen==="measures"){
    var today = new Date().toISOString().slice(0,10);
    var measures = getMeasures().slice().sort(function(a,b){ return a.date.localeCompare(b.date); });

    var list = measures.map(function(m){
      return `
      <div class="list-item">
        <div class="list-main">
          <b>${m.date}</b>
          <div class="small">
            Kilo:${m.weight||""} | Bel:${m.waist||""} | GÃ¶ÄŸÃ¼s:${m.chest||""} | Kol:${m.arm||""} | Omuz:${m.shoulder||""} | KalÃ§a:${m.hip||""}
          </div>
        </div>
        <button class="icon-btn" onclick="editMeasure('${m.date}')">âœï¸</button>
        <button class="icon-btn delete" onclick="deleteMeasure('${m.date}')">ğŸ—‘ï¸</button>
      </div>`;
    }).join("");

    app.innerHTML = `
      <div class="card">
        <h3>âš–ï¸ Ã–lÃ§Ã¼ GiriÅŸi</h3>
        <input type="date" id="m-date" value="${today}">
        <div class="grid">
          <input id="m-weight" placeholder="Kilo">
          <input id="m-waist" placeholder="Bel">
          <input id="m-chest" placeholder="GÃ¶ÄŸÃ¼s">
          <input id="m-arm" placeholder="Kol">
          <input id="m-shoulder" placeholder="Omuz">
          <input id="m-hip" placeholder="KalÃ§a">
        </div>
        <button onclick="saveMeasure()">ğŸ’¾ Kaydet / GÃ¼ncelle</button>
        <button onclick="goMeasureExport()">ğŸ“¤ Ã–lÃ§Ã¼leri Export</button>
        <button onclick="goMeasureCharts()">ğŸ“ˆ Grafikleri GÃ¶r</button>
      </div>

      <div class="card">
        <h3>ğŸ“œ GeÃ§miÅŸ Ã–lÃ§Ã¼ler</h3>
        ${list || "<div class='small'>HenÃ¼z kayÄ±t yok</div>"}
      </div>

      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="measureCharts"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“ˆ Kilo GrafiÄŸi</h3>
        <canvas id="weightChart" width="400" height="260"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ“ˆ Ã–lÃ§Ã¼ GrafiÄŸi</h3>
        <select id="measureSelect" onchange="drawMeasureCharts()">
          <option value="waist">Bel</option>
          <option value="chest">GÃ¶ÄŸÃ¼s</option>
          <option value="arm">Kol</option>
          <option value="shoulder">Omuz</option>
          <option value="hip">KalÃ§a</option>
        </select>
        <canvas id="measureChart" width="400" height="260"></canvas>
      </div>

      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
    drawMeasureCharts();
  }

  if(state.screen==="measureExport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ Ã–lÃ§Ã¼ Export</h3>
        <button onclick="exportMeasuresJSON()">ğŸ“¦ JSON (Yedek)</button>
        <button onclick="exportMeasuresCSV()">ğŸ“Š CSV (Excel/GPT)</button>
      </div>
      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="programExport"){
    var i = state.exportProgramIndex;
    var programs3 = getPrograms();
    var p2 = programs3[i];
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ ${p2.name}</h3>
        <button onclick="exportProgramJSON(${i})">ğŸ“¦ Program JSON (Yedek)</button>
        <button onclick="exportProgramCSV(${i})">ğŸ“Š Program CSV (Antrenman KayÄ±tlarÄ±)</button>
      </div>
      <button onclick="goPrograms()">â¬…ï¸ Geri</button>
    `;
  }
}

// ===== Backup Import (FIXED) =====
function selectBackup(){
  document.getElementById("backupInput").click();
}

document.getElementById("backupInput").addEventListener("change", function(e){
  var file = e.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(evt){
    try{
      var data = JSON.parse(evt.target.result);

      // TEK PROGRAM
      if(data && data.name && Array.isArray(data.days)){
        if(confirm("Bu bir PROGRAM yedeÄŸi. Mevcut programlara EKLENSÄ°N mi?")){
          var programs = getPrograms();
          programs.push(data);
          savePrograms(programs);
          alert("Program iÃ§e aktarÄ±ldÄ± âœ…");
        }
        return;
      }

      // PROGRAM LÄ°STESÄ°
      if(Array.isArray(data) && data.length && data[0].name && data[0].days){
        if(confirm("Bu iÅŸlem MEVCUT TÃœM PROGRAMLARIN Ã¼stÃ¼ne yazacak. Emin misin?")){
          savePrograms(data);
          alert("Programlar yÃ¼klendi âœ…");
        }
        return;
      }

      // Ã–LÃ‡Ãœ LÄ°STESÄ°
      if(Array.isArray(data) && (data.length===0 || data[0].date)){
        if(confirm("Bu iÅŸlem MEVCUT TÃœM Ã–LÃ‡ÃœLERÄ°N Ã¼stÃ¼ne yazacak. Emin misin?")){
          saveMeasures(data);
          alert("Ã–lÃ§Ã¼ler yÃ¼klendi âœ…");
        }
        return;
      }

      alert("Bu dosya tanÄ±nan bir yedek formatÄ± deÄŸil.");

    }catch(err){
      alert("GeÃ§ersiz JSON dosyasÄ±.");
    }
  };
  reader.readAsText(file);
});

// ===== Charts, Program, Measure, Export fonksiyonlarÄ± =====
// (Bunlar Ã¶nceki sÃ¼rÃ¼mle aynÄ± â€“ DEÄÄ°ÅTÄ°RÄ°LMEDÄ°)

// ===== Init =====
render();
</script>

</body>
</html>
