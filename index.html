<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spor Takip</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#f2f2f7; }
header { background:#111; color:white; padding:12px 16px; font-size:20px; text-align:center; position:relative; }
header .home-btn { position:absolute; right:12px; top:10px; font-size:22px; background:none; border:none; color:white; }
.container { padding:16px; }
.card { background:white; border-radius:12px; padding:16px; margin-bottom:12px; }
button { font-size:17px; padding:14px; width:100%; border:none; border-radius:10px; background:black; color:white; margin-bottom:10px; }
.list-item { padding:12px; border-bottom:1px solid #ddd; display:flex; align-items:center; gap:10px; }
.list-item:last-child { border-bottom:none; }
.list-main { flex:1; }
.icon-btn { background:#eee; border:none; border-radius:8px; padding:8px 10px; font-size:16px; }
.icon-btn.delete { background:#ffdddd; }
.icon-btn.export { background:#ddeaff; }
.done { color:green; font-weight:600; }
.todo { color:#999; }
.set-row { display:flex; gap:8px; }
.set-row input { flex:1; padding:10px; font-size:16px; }
input, select { padding:10px; font-size:16px; width:100%; margin-bottom:8px; }
.small { color:#666; font-size:14px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
canvas { width:100%; height:260px; border:1px solid #eee; border-radius:8px; }
</style>
</head>
<body>

<header>
  ğŸ‹ï¸ Spor Takip
  <button class="home-btn" onclick="goHome()">ğŸ </button>
</header>

<div class="container" id="app"></div>

<input type="file" id="fileInput" accept=".csv" style="display:none" />
<input type="file" id="backupInput" accept=".json" style="display:none" />

<script>
var BOM = "\uFEFF";

var state = {
  screen: "home",
  selectedProgram: null,
};

// ===== Storage =====
function getPrograms() { return JSON.parse(localStorage.getItem("programs") || "[]"); }
function savePrograms(p) { localStorage.setItem("programs", JSON.stringify(p)); }
function getMeasures() { return JSON.parse(localStorage.getItem("measures") || "[]"); }
function saveMeasures(m) { localStorage.setItem("measures", JSON.stringify(m)); }

// ===== Navigation =====
function goHome(){ state.screen="home"; render(); }
function goPrograms(){ state.screen="programs"; render(); }
function goMeasures(){ state.screen="measures"; render(); }
function goMeasureExport(){ state.screen="measureExport"; render(); }
function goMeasureCharts(){ state.screen="measureCharts"; render(); }
function goBackupImport(){ state.screen="backupImport"; render(); }

// ===== Render =====
function render(){
  var app = document.getElementById("app");
  app.innerHTML = "";

  if(state.screen==="home"){
    app.innerHTML = `
      <div class="card"><button onclick="goPrograms()">ğŸ“‹ Program SeÃ§</button></div>
      <div class="card"><button onclick="goMeasures()">âš–ï¸ Ã–lÃ§Ã¼ Takibi</button></div>
      <div class="card"><button onclick="importProgram()">â• Yeni Program Ekle (CSV)</button></div>
      <div class="card"><button onclick="goBackupImport()">ğŸ“¥ Yedek Ä°Ã§e Aktar</button></div>
    `;
  }

  if(state.screen==="backupImport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¥ Yedek Ä°Ã§e Aktar</h3>
        <div class="small">Program JSON veya Ã–lÃ§Ã¼ JSON dosyasÄ±nÄ± seÃ§ebilirsin.</div>
        <button onclick="selectBackup()">ğŸ“‚ Dosya SeÃ§</button>
        <div class="small">âš ï¸ AynÄ± tÃ¼rdeki mevcut verilerin Ã¼zerine yazar.</div>
      </div>
      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="programs"){
    var programs = getPrograms();
    var html = `<div class="card"><h3>ğŸ“‹ Programlar</h3>`;
    programs.forEach(function(p,i){
      html += `
        <div class="list-item">
          <div class="list-main" onclick="openProgram(${i})">${p.name}</div>
          <button class="icon-btn export" onclick="exportProgramMenu(${i})">ğŸ“¤</button>
          <button class="icon-btn" onclick="renameProgram(${i})">âœï¸</button>
          <button class="icon-btn delete" onclick="deleteProgram(${i})">ğŸ—‘ï¸</button>
        </div>
      `;
    });
    html += `</div><button onclick="goHome()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html;
  }

  if(state.screen==="programDetail"){
    var p = state.selectedProgram;
    var html2 = `<div class="card"><h3>${p.name}</h3>`;
    p.days.forEach(function(d,i){
      html2 += `
        <div class="list-item" onclick="openDay(${i})">
          <div class="list-main">
            ${d.name} - ${d.records ? "<span class='done'>TamamlandÄ±</span>" : "<span class='todo'>YapÄ±lmadÄ±</span>"}
          </div>
        </div>
      `;
    });
    html2 += `</div><button onclick="goPrograms()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html2;
  }

  if(state.screen==="workout"){
    var programs2 = getPrograms();
    var day = programs2[state.programIndex].days[state.selectedDayIndex];
    var html3 = `<div class="card"><h3>${day.name}</h3>`;

    day.exercises.forEach(function(ex,ei){
      html3 += `<div class="card">
        <b>${ex.name}</b>
        <div class="small">Hedef: ${ex.sets} x ${ex.reps}</div>`;
      for(var s=0;s<ex.sets;s++){
        var old = (day.records && day.records[ex.name] && day.records[ex.name][s]) || {};
        html3 += `
          <div class="set-row">
            <input placeholder="Set ${s+1} KG" id="kg-${ei}-${s}" value="${old.kg||""}">
            <input placeholder="Tekrar" id="rep-${ei}-${s}" value="${old.rep||""}">
          </div>
        `;
      }
      html3 += `</div>`;
    });

    html3 += `<button onclick="saveDay()">ğŸ’¾ GÃ¼nÃ¼ Kaydet</button>
             <button onclick="renderProgramDetail()">â¬…ï¸ Geri</button>`;
    app.innerHTML = html3;
  }

  if(state.screen==="measures"){
    var today = new Date().toISOString().slice(0,10);
    var measures = getMeasures().slice().sort(function(a,b){ return a.date.localeCompare(b.date); });

    var list = measures.map(function(m){
      return `
      <div class="list-item">
        <div class="list-main">
          <b>${m.date}</b>
          <div class="small">
            Kilo:${m.weight||""} | Bel:${m.waist||""} | GÃ¶ÄŸÃ¼s:${m.chest||""} | Kol:${m.arm||""} | Omuz:${m.shoulder||""} | KalÃ§a:${m.hip||""}
          </div>
        </div>
        <button class="icon-btn" onclick="editMeasure('${m.date}')">âœï¸</button>
        <button class="icon-btn delete" onclick="deleteMeasure('${m.date}')">ğŸ—‘ï¸</button>
      </div>`;
    }).join("");

    app.innerHTML = `
      <div class="card">
        <h3>âš–ï¸ Ã–lÃ§Ã¼ GiriÅŸi</h3>
        <input type="date" id="m-date" value="${today}">
        <div class="grid">
          <input id="m-weight" placeholder="Kilo">
          <input id="m-waist" placeholder="Bel">
          <input id="m-chest" placeholder="GÃ¶ÄŸÃ¼s">
          <input id="m-arm" placeholder="Kol">
          <input id="m-shoulder" placeholder="Omuz">
          <input id="m-hip" placeholder="KalÃ§a">
        </div>
        <button onclick="saveMeasure()">ğŸ’¾ Kaydet / GÃ¼ncelle</button>
        <button onclick="goMeasureExport()">ğŸ“¤ Ã–lÃ§Ã¼leri Export</button>
        <button onclick="goMeasureCharts()">ğŸ“ˆ Grafikleri GÃ¶r</button>
      </div>

      <div class="card">
        <h3>ğŸ“œ GeÃ§miÅŸ Ã–lÃ§Ã¼ler</h3>
        ${list || "<div class='small'>HenÃ¼z kayÄ±t yok</div>"}
      </div>

      <button onclick="goHome()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="measureCharts"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“ˆ Kilo GrafiÄŸi</h3>
        <canvas id="weightChart" width="400" height="260"></canvas>
      </div>

      <div class="card">
        <h3>ğŸ“ˆ Ã–lÃ§Ã¼ GrafiÄŸi</h3>
        <select id="measureSelect" onchange="drawMeasureCharts()">
          <option value="waist">Bel</option>
          <option value="chest">GÃ¶ÄŸÃ¼s</option>
          <option value="arm">Kol</option>
          <option value="shoulder">Omuz</option>
          <option value="hip">KalÃ§a</option>
        </select>
        <canvas id="measureChart" width="400" height="260"></canvas>
      </div>

      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
    drawMeasureCharts();
  }

  if(state.screen==="measureExport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ Ã–lÃ§Ã¼ Export</h3>
        <button onclick="exportMeasuresJSON()">ğŸ“¦ JSON (Yedek)</button>
        <button onclick="exportMeasuresCSV()">ğŸ“Š CSV (Excel/GPT)</button>
      </div>
      <button onclick="goMeasures()">â¬…ï¸ Geri</button>
    `;
  }

  if(state.screen==="programExport"){
    var i = state.exportProgramIndex;
    var programs3 = getPrograms();
    var p2 = programs3[i];
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ ${p2.name}</h3>
        <button onclick="exportProgramJSON(${i})">ğŸ“¦ Program JSON (Yedek)</button>
        <button onclick="exportProgramCSV(${i})">ğŸ“Š Program CSV (Antrenman KayÄ±tlarÄ±)</button>
      </div>
      <button onclick="goPrograms()">â¬…ï¸ Geri</button>
    `;
  }
}

// ===== Backup Import =====
function selectBackup(){
  document.getElementById("backupInput").click();
}

document.getElementById("backupInput").addEventListener("change", function(e){
  var file = e.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(evt){
    try{
      var data = JSON.parse(evt.target.result);
      if(Array.isArray(data) && data.length && data[0].days){
        if(confirm("Bu iÅŸlem mevcut PROGRAMLARIN Ã¼stÃ¼ne yazacak. Emin misin?")){
          savePrograms(data);
          alert("Program yedeÄŸi yÃ¼klendi âœ…");
        }
      } else if(Array.isArray(data) && (data.length===0 || data[0].date)){
        if(confirm("Bu iÅŸlem mevcut Ã–LÃ‡ÃœLERÄ°N Ã¼stÃ¼ne yazacak. Emin misin?")){
          saveMeasures(data);
          alert("Ã–lÃ§Ã¼ yedeÄŸi yÃ¼klendi âœ…");
        }
      } else {
        alert("Bu dosya tanÄ±nan bir yedek formatÄ± deÄŸil.");
      }
    }catch(err){
      alert("GeÃ§ersiz JSON dosyasÄ±.");
    }
  };
  reader.readAsText(file);
});

// ===== Charts (aynÄ±) =====
function drawMeasureCharts(){
  var measures = getMeasures().slice().sort(function(a,b){ return a.date.localeCompare(b.date); });

  var weightData = measures.filter(function(m){return m.weight;}).map(function(m){return {x:m.date, v:parseFloat(m.weight)};});
  drawLineChart("weightChart", weightData, "#007aff");

  var key = document.getElementById("measureSelect").value;
  var colorMap = { waist:"#ff9500", chest:"#34c759", arm:"#af52de", shoulder:"#ff3b30", hip:"#5ac8fa" };
  var mData = measures.filter(function(m){return m[key];}).map(function(m){return {x:m.date, v:parseFloat(m[key])};});
  drawLineChart("measureChart", mData, colorMap[key] || "#000");
}

function drawLineChart(canvasId, data, color){
  var c = document.getElementById(canvasId);
  if(!c) return;
  var ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  if(data.length < 1){
    ctx.fillStyle="#999";
    ctx.fillText("Yeterli veri yok", 20, 40);
    return;
  }

  var pad = 40;
  var w = c.width - pad*2;
  var h = c.height - pad*2;

  var minY = Math.min.apply(null, data.map(function(d){return d.v;}));
  var maxY = Math.max.apply(null, data.map(function(d){return d.v;}));
  var range = (maxY - minY) || 1;

  ctx.strokeStyle="#ccc";
  ctx.beginPath();
  ctx.moveTo(pad,pad);
  ctx.lineTo(pad,pad+h);
  ctx.lineTo(pad+w,pad+h);
  ctx.stroke();

  ctx.fillStyle="#666";
  ctx.font="12px sans-serif";
  ctx.fillText(maxY.toFixed(1), 5, pad+5);
  ctx.fillText(minY.toFixed(1), 5, pad+h);

  ctx.strokeStyle=color;
  ctx.lineWidth=2;
  ctx.beginPath();

  data.forEach(function(d,i){
    var x = pad + (i/((data.length-1)||1))*w;
    var y = pad + h - ((d.v - minY)/range)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);

    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  ctx.stroke();
}

// ===== Program Flow, Import, Export, Measure CRUD (stabil) =====
// (AÅŸaÄŸÄ±daki fonksiyonlar Ã¶nceki sÃ¼rÃ¼mle aynÄ±dÄ±r)

function openProgram(i){
  var programs = getPrograms();
  state.selectedProgram = programs[i];
  state.programIndex = i;
  state.screen = "programDetail";
  render();
}
function renderProgramDetail(){ state.screen="programDetail"; render(); }
function openDay(i){ state.selectedDayIndex=i; state.screen="workout"; render(); }

function saveDay(){
  var programs = getPrograms();
  var day = programs[state.programIndex].days[state.selectedDayIndex];
  var records = {};
  day.exercises.forEach(function(ex,ei){
    records[ex.name]=[];
    for(var s=0;s<ex.sets;s++){
      var kg = document.getElementById("kg-"+ei+"-"+s).value;
      var rep = document.getElementById("rep-"+ei+"-"+s).value;
      records[ex.name].push({kg:kg,rep:rep});
    }
  });
  day.records = records;
  savePrograms(programs);
  alert("GÃ¼n kaydedildi ğŸ’ª");
  renderProgramDetail();
}

function importProgram(){ document.getElementById("fileInput").click(); }
document.getElementById("fileInput").addEventListener("change", function(e){
  var file = e.target.files[0];
  var reader = new FileReader();
  reader.onload = function(evt){ parseCSV(evt.target.result); };
  reader.readAsText(file);
});

function parseCSV(text){
  var lines = text.split("\n").map(function(l){return l.trim();}).filter(function(l){return l;});
  var rows = lines.slice(1).map(function(l){return l.split(",");});
  var programName = rows[0][0];
  var program = { name: programName, days: [] };
  var dayMap = {};
  rows.forEach(function(r){
    var week=r[1], day=r[2], exercise=r[3];
    var sets=parseInt(r[4]), reps=parseInt(r[5]);
    var key = "Hafta "+week+" GÃ¼n "+day;
    if(!dayMap[key]){ dayMap[key]={ name:key, exercises:[] }; program.days.push(dayMap[key]); }
    dayMap[key].exercises.push({ name:exercise, sets:sets, reps:reps });
  });
  var programs = getPrograms();
  programs.push(program);
  savePrograms(programs);
  alert("Program eklendi âœ…");
}

function deleteProgram(i){
  if(!confirm("Bu programÄ± silmek istiyor musun?")) return;
  var programs = getPrograms();
  programs.splice(i,1); savePrograms(programs); render();
}
function renameProgram(i){
  var programs = getPrograms();
  var newName = prompt("Yeni program adÄ±nÄ± gir:", programs[i].name);
  if(!newName) return;
  programs[i].name = newName; savePrograms(programs); render();
}

function downloadFile(filename, content, type){
  var blob = new Blob([content], {type:type});
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportProgramMenu(i){ state.exportProgramIndex=i; state.screen="programExport"; render(); }

function exportProgramJSON(i){
  var programs = getPrograms();
  var data = JSON.stringify(programs[i], null, 2);
  downloadFile("program_"+programs[i].name+".json", data, "application/json");
}

function exportProgramCSV(i){
  var programs = getPrograms();
  var p = programs[i];
  var rows = [];
  rows.push(["Program","GÃ¼n","Hareket","SetNo","KG","Tekrar"].join(","));
  p.days.forEach(function(d){
    if(d.records){
      Object.keys(d.records).forEach(function(exName){
        d.records[exName].forEach(function(set,idx){
          rows.push([
            "\""+p.name+"\"", "\""+d.name+"\"", "\""+exName+"\"", idx+1, set.kg||"", set.rep||""
          ].join(","));
        });
      });
    }
  });
  var csv = BOM + rows.join("\n");
  downloadFile("program_"+p.name+"_antrenman.csv", csv, "text/csv;charset=utf-8;");
}

function saveMeasure(){
  var m = {
    date: document.getElementById("m-date").value,
    weight: document.getElementById("m-weight").value,
    waist: document.getElementById("m-waist").value,
    chest: document.getElementById("m-chest").value,
    arm: document.getElementById("m-arm").value,
    shoulder: document.getElementById("m-shoulder").value,
    hip: document.getElementById("m-hip").value,
  };
  var measures = getMeasures().filter(function(x){return x.date!==m.date;});
  measures.push(m);
  saveMeasures(measures);
  alert("Ã–lÃ§Ã¼ kaydedildi âœ…");
  render();
}

function editMeasure(date){
  var m = getMeasures().find(function(x){return x.date===date;});
  if(!m) return;
  document.getElementById("m-date").value = m.date;
  document.getElementById("m-weight").value = m.weight||"";
  document.getElementById("m-waist").value = m.waist||"";
  document.getElementById("m-chest").value = m.chest||"";
  document.getElementById("m-arm").value = m.arm||"";
  document.getElementById("m-shoulder").value = m.shoulder||"";
  document.getElementById("m-hip").value = m.hip||"";
}

function deleteMeasure(date){
  if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
  var measures = getMeasures().filter(function(x){return x.date!==date;});
  saveMeasures(measures);
  render();
}

function exportMeasuresJSON(){
  var data = JSON.stringify(getMeasures(), null, 2);
  downloadFile("olcu_verilerim.json", data, "application/json");
}

function exportMeasuresCSV(){
  var m = getMeasures().sort(function(a,b){ return a.date.localeCompare(b.date); });
  var rows = [];
  rows.push(["Tarih","Kilo","Bel","GÃ¶ÄŸÃ¼s","Kol","Omuz","KalÃ§a"].join(","));
  m.forEach(function(x){
    rows.push([x.date, x.weight||"", x.waist||"", x.chest||"", x.arm||"", x.shoulder||"", x.hip||""].join(","));
  });
  var csv = BOM + rows.join("\n");
  downloadFile("olcu_verilerim.csv", csv, "text/csv;charset=utf-8;");
}

// ===== Init =====
render();
</script>

</body>
</html>
