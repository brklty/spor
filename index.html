<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spor Takip</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; background:#f2f2f7; }
header { background:#111; color:white; padding:16px; font-size:20px; text-align:center; position:relative; }
.home-btn {
  position:absolute; right:12px; top:12px;
  background:#333; color:white; border:none;
  border-radius:8px; padding:6px 10px; font-size:18px;
}
.container { padding:16px; }
.card { background:white; border-radius:12px; padding:16px; margin-bottom:12px; }
button { font-size:17px; padding:14px; width:100%; border:none; border-radius:10px; background:black; color:white; margin-bottom:10px; }
.list-item { padding:12px; border-bottom:1px solid #ddd; display:flex; align-items:center; gap:10px; }
.list-item:last-child { border-bottom:none; }
.list-main { flex:1; }
.icon-btn { background:#eee; border:none; border-radius:8px; padding:8px 10px; font-size:16px; }
.icon-btn.delete { background:#ffdddd; }
.icon-btn.export { background:#ddeaff; }
.done { color:green; font-weight:600; }
.todo { color:#999; }
.set-row { display:flex; gap:8px; }
.set-row input { flex:1; padding:10px; font-size:16px; }
input, select { padding:10px; font-size:16px; width:100%; margin-bottom:8px; }
.small { color:#666; font-size:14px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
</style>
</head>
<body>

<header>
  ğŸ‹ï¸ Spor Takip
  <button id="homeBtn" class="home-btn" onclick="goHome()" style="display:none">ğŸ </button>
</header>

<div class="container" id="app"></div>

<input type="file" id="fileInput" accept=".csv" style="display:none" />
<input type="file" id="importInput" accept=".json" style="display:none" />

<script>
const BOM = "\uFEFF";

let state = {
  screen: "home",
  selectedProgram: null,
};

// ===== Storage =====
function getPrograms() { return JSON.parse(localStorage.getItem("programs") || "[]"); }
function savePrograms(p) { localStorage.setItem("programs", JSON.stringify(p)); }
function getMeasures() { return JSON.parse(localStorage.getItem("measures") || "[]"); }
function saveMeasures(m) { localStorage.setItem("measures", JSON.stringify(m)); }

// ===== Navigation =====
function goHome(){ state.screen="home"; render(); }
function goPrograms(){ state.screen="programs"; render(); }
function goMeasures(){ state.screen="measures"; render(); }
function goMeasureExport(){ state.screen="measureExport"; render(); }
function goImportBackup(){ state.screen="importBackup"; render(); }

// ===== Render =====
function render(){
  const app = document.getElementById("app");
  const homeBtn = document.getElementById("homeBtn");

  homeBtn.style.display = (state.screen === "home") ? "none" : "block";

  app.innerHTML = "";

  if(state.screen==="home"){
    app.innerHTML = `
      <div class="card"><button onclick="goPrograms()">ğŸ“‹ Program SeÃ§</button></div>
      <div class="card"><button onclick="goMeasures()">âš–ï¸ Ã–lÃ§Ã¼ Takibi</button></div>
      <div class="card"><button onclick="importProgram()">â• Yeni Program Ekle (CSV)</button></div>
      <div class="card"><button onclick="goImportBackup()">ğŸ“¥ Yedek Ä°Ã§e Aktar</button></div>
    `;
  }

  if(state.screen==="importBackup"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¥ Yedek Ä°Ã§e Aktar</h3>
        <button onclick="startImport()">ğŸ“‚ JSON Yedek SeÃ§</button>
        <div class="small">
          Program veya Ã–lÃ§Ã¼ yedeÄŸi seÃ§ebilirsin.
        </div>
      </div>
    `;
  }

  if(state.screen==="programs"){
    const programs = getPrograms();
    let html = `<div class="card"><h3>ğŸ“‹ Programlar</h3>`;
    programs.forEach((p,i)=>{
      html += `
        <div class="list-item">
          <div class="list-main" onclick="openProgram(${i})">${p.name}</div>
          <button class="icon-btn export" onclick="exportProgramMenu(${i})">ğŸ“¤</button>
          <button class="icon-btn" onclick="renameProgram(${i})">âœï¸</button>
          <button class="icon-btn delete" onclick="deleteProgram(${i})">ğŸ—‘ï¸</button>
        </div>
      `;
    });
    html += `</div>`;
    app.innerHTML = html;
  }

  if(state.screen==="measures"){
    const today = new Date().toISOString().slice(0,10);
    let measures = getMeasures().slice().sort((a,b)=> a.date.localeCompare(b.date));

    let list = measures.map(m=>`
      <div class="list-item">
        <div class="list-main">
          <b>${m.date}</b>
          <div class="small">
            Kilo:${m.weight||""} | Bel:${m.waist||""} | GÃ¶ÄŸÃ¼s:${m.chest||""} | Kol:${m.arm||""} | Omuz:${m.shoulder||""} | KalÃ§a:${m.hip||""}
          </div>
        </div>
        <button class="icon-btn" onclick="editMeasure('${m.date}')">âœï¸</button>
        <button class="icon-btn delete" onclick="deleteMeasure('${m.date}')">ğŸ—‘ï¸</button>
      </div>
    `).join("");

    app.innerHTML = `
      <div class="card">
        <h3>âš–ï¸ Ã–lÃ§Ã¼ GiriÅŸi</h3>
        <input type="date" id="m-date" value="${today}">
        <div class="grid">
          <input id="m-weight" placeholder="Kilo">
          <input id="m-waist" placeholder="Bel">
          <input id="m-chest" placeholder="GÃ¶ÄŸÃ¼s">
          <input id="m-arm" placeholder="Kol">
          <input id="m-shoulder" placeholder="Omuz">
          <input id="m-hip" placeholder="KalÃ§a">
        </div>
        <button onclick="saveMeasure()">ğŸ’¾ Kaydet / GÃ¼ncelle</button>
        <button onclick="goMeasureExport()">ğŸ“¤ Ã–lÃ§Ã¼leri Export</button>
      </div>

      <div class="card">
        <h3>ğŸ“œ GeÃ§miÅŸ Ã–lÃ§Ã¼ler</h3>
        ${list || "<div class='small'>HenÃ¼z kayÄ±t yok</div>"}
      </div>
    `;
  }

  if(state.screen==="measureExport"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“¤ Ã–lÃ§Ã¼ Export</h3>
        <button onclick="exportMeasuresJSON()">ğŸ“¦ JSON (Yedek)</button>
        <button onclick="exportMeasuresCSV()">ğŸ“Š CSV (Excel/GPT)</button>
      </div>
    `;
  }
}

// ===== Import Backup =====
function startImport(){
  document.getElementById("importInput").click();
}

document.getElementById("importInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt){
    try {
      const data = JSON.parse(evt.target.result);
      handleImportData(data);
    } catch(err){
      alert("Bu dosya geÃ§erli bir yedek deÄŸil.");
    }
  };
  reader.readAsText(file);
});

function handleImportData(data){
  // Program yedeÄŸi mi?
  if(data && data.days && data.name){
    importProgramBackup(data);
    return;
  }
  // Ã–lÃ§Ã¼ yedeÄŸi mi?
  if(Array.isArray(data) && data.length && data[0].date){
    importMeasureBackup(data);
    return;
  }
  alert("Bu dosya tanÄ±nan bir yedek formatÄ± deÄŸil.");
}

function importProgramBackup(p){
  let programs = getPrograms();
  const existing = programs.find(x=>x.name===p.name);
  if(existing){
    const choice = confirm("Bu isimde bir program var. Ãœzerine yazmak iÃ§in OK, kopya oluÅŸturmak iÃ§in Ä°ptal.");
    if(choice){
      programs = programs.map(x=> x.name===p.name ? p : x);
    } else {
      let base = p.name;
      let i = 2;
      let newName = base + "_" + i;
      while(programs.find(x=>x.name===newName)){ i++; newName = base + "_" + i; }
      p.name = newName;
      programs.push(p);
    }
  } else {
    programs.push(p);
  }
  savePrograms(programs);
  alert("Program iÃ§e aktarÄ±ldÄ± âœ…");
}

function importMeasureBackup(arr){
  let measures = getMeasures();
  arr.forEach(m=>{
    measures = measures.filter(x=>x.date!==m.date);
    measures.push(m);
  });
  saveMeasures(measures);
  alert("Ã–lÃ§Ã¼ler iÃ§e aktarÄ±ldÄ± âœ…");
}

// ===== CSV Import (mevcut sistem) =====
function importProgram(){ document.getElementById("fileInput").click(); }
document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = evt => parseCSV(evt.target.result);
  reader.readAsText(file);
});

function parseCSV(text){
  const lines = text.split("\n").map(l=>l.trim()).filter(l=>l);
  const rows = lines.slice(1).map(l=>l.split(","));
  const programName = rows[0][0];
  let program = { name: programName, days: [] };
  let dayMap = {};
  rows.forEach(r=>{
    const week=r[1], day=r[2], exercise=r[3];
    const sets=parseInt(r[4]), reps=parseInt(r[5]);
    const key = `Hafta ${week} GÃ¼n ${day}`;
    if(!dayMap[key]){ dayMap[key]={ name:key, exercises:[] }; program.days.push(dayMap[key]); }
    dayMap[key].exercises.push({ name:exercise, sets, reps });
  });
  const programs = getPrograms();
  programs.push(program);
  savePrograms(programs);
  alert("Program eklendi âœ…");
}

// ===== Measures =====
function saveMeasure(){
  const m = {
    date: document.getElementById("m-date").value,
    weight: document.getElementById("m-weight").value,
    waist: document.getElementById("m-waist").value,
    chest: document.getElementById("m-chest").value,
    arm: document.getElementById("m-arm").value,
    shoulder: document.getElementById("m-shoulder").value,
    hip: document.getElementById("m-hip").value,
  };
  let measures = getMeasures();
  measures = measures.filter(x=>x.date!==m.date);
  measures.push(m);
  saveMeasures(measures);
  alert("Ã–lÃ§Ã¼ kaydedildi âœ…");
  render();
}

function editMeasure(date){
  const m = getMeasures().find(x=>x.date===date);
  if(!m) return;
  document.getElementById("m-date").value = m.date;
  document.getElementById("m-weight").value = m.weight||"";
  document.getElementById("m-waist").value = m.waist||"";
  document.getElementById("m-chest").value = m.chest||"";
  document.getElementById("m-arm").value = m.arm||"";
  document.getElementById("m-shoulder").value = m.shoulder||"";
  document.getElementById("m-hip").value = m.hip||"";
}

function deleteMeasure(date){
  if(!confirm("Bu kaydÄ± silmek istiyor musun?")) return;
  let measures = getMeasures().filter(x=>x.date!==date);
  saveMeasures(measures);
  render();
}

// ===== Export =====
function downloadFile(filename, content, type){
  const blob = new Blob([content], {type});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportMeasuresJSON(){
  const data = JSON.stringify(getMeasures(), null, 2);
  downloadFile("olcu_verilerim.json", data, "application/json");
}

function exportMeasuresCSV(){
  const m = getMeasures().sort((a,b)=> a.date.localeCompare(b.date));
  let rows = [];
  rows.push(["Tarih","Kilo","Bel","GÃ¶ÄŸÃ¼s","Kol","Omuz","KalÃ§a"].join(","));
  m.forEach(x=>{
    rows.push([x.date, x.weight||"", x.waist||"", x.chest||"", x.arm||"", x.shoulder||"", x.hip||""].join(","));
  });
  const csv = BOM + rows.join("\n");
  downloadFile("olcu_verilerim.csv", csv, "text/csv;charset=utf-8;");
}

// ===== Init =====
render();
</script>

</body>
</html>
